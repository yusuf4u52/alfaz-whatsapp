<!DOCTYPE html>
<html>

<head>
  <title>WhatsApp Client UI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous" />
</head>

<body>
  <br />
  <div class="container" style="width: 50%">
    <h1>Send WhatsApp Message</h1>

    <img id="qrCode" alt="QR Code" style="display: none" />

    <form class="row g-3" id="sendForm">
      <label class="form-label" for="phoneNumber">To WhatsApp Numbers</label>
      <input class="form-control" type="text" id="phoneNumber" name="phoneNumber"
        placeholder="91xxxxxxxxxx,91xxxxxxxxxx" />
      <label class="form-label" for="message">Enter Message to send</label>
      <textarea class="form-control" id="message" rows="3" name="message"></textarea>
      <label class="form-label" for="file">Upload Files to Send</label>
      <input type="file" id="file" class="form-control" name="file" />

      <button class="btn btn-primary" id="sendMessageButton">
        Send Message
      </button>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script type="module">
    import { v4 as uuidv4 } from 'https://jspm.dev/uuid';
    const uuid = uuidv4(); // â‡¨ '1b9d6bcd-bbfd-4b2d-9b5d-ab8dfbbd4bed'
    if (!localStorage.getItem("uuid")) {
      localStorage.setItem("uuid", uuid);
    }
  </script>
  <script>
    const sessionName = localStorage.getItem("uuid");
    const qrCodeImage = document.getElementById("qrCode");
    const sendMessageButton = document.getElementById("sendMessageButton");

    const socket = io(); // Create Socket.IO client connection
    socket.emit('subscribe', sessionName);

    socket.on("newQRCode", (qrDataURL) => {
      qrCodeImage.style.display = "none";
      qrCodeImage.src = qrDataURL;
      qrCodeImage.style.display = "block";
    });

    socket.on("ready", () => {
      qrCodeImage.style.display = "none";
      sendMessageButton.disabled = false;
      sendMessageButton.innerHTML = "Send Message";
    });

    socket.on("connecting", () => {
      sendMessageButton.innerHTML = "Wait for Whatsapp client to be ready";
      sendMessageButton.disabled = true;
    });

    socket.on("disconnected", () => {
      location.reload();
    });

    if (sessionName) {
      const response = fetch(`/api/generate-qr/${sessionName}`);
    }

    // send message
    sendMessageButton.addEventListener("click", async (e) => {
      e.preventDefault();
      const form = document.getElementById("sendForm");
      const formdata = new FormData(form);

      const response = await fetch(`/api/send-whatsapp/${sessionName}`, {
        method: "POST",
        body: formdata
      });

      if (response.ok) {
        alert("Message sent successfully");
      } else {
        alert("Error sending message");
      }
    });
  </script>
</body>

</html>