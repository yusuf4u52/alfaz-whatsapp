<!DOCTYPE html>
<html>

<head>
  <title>WhatsApp Client UI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous" />
</head>

<body>
  <nav class="navbar" style="background-color: #e3f2fd;">
    <div class="container-fluid">
      <a class="navbar-brand">Welcome <%= user.name || user.username %></a>
      <form  action="/logout" method="post" class="d-flex">
        <button class="btn btn-outline-success" type="submit">Logout</button>
      </form>
    </div>
  </nav>
  
  <br />
  <div class="container">
    <h1>Send WhatsApp Message</h1>

    <img id="qrCode" alt="QR Code" style="display: none" />

    <form class="row g-3" id="sendForm">
      <label class="form-label" for="phoneNumber">To WhatsApp Numbers</label>
      <input class="form-control" type="text" id="phoneNumber" name="phoneNumber"
        placeholder="91xxxxxxxxxx,91xxxxxxxxxx" />
      <label class="form-label" for="message">Enter Message to send</label>
      <textarea class="form-control" id="message" rows="3" name="message"></textarea>
      <label class="form-label" for="file">Upload Files to Send</label>
      <input type="file" id="file" class="form-control" name="file" />

      <button class="btn btn-primary" id="sendMessageButton">
        Send Message
      </button>
    </form>
  </div>

  <script>
    const sessionName = localStorage.getItem("uuid");
    const qrCodeImage = document.getElementById("qrCode");
    const sendMessageButton = document.getElementById("sendMessageButton");
    const EVENT_THRESHOLD = 2;

    const socket = io(); // Create Socket.IO client connection
    socket.emit('subscribe', sessionName);

    let eventCount = 0;
    socket.on("newQRCode", (qrDataURL) => {
      eventCount++;
      localStorage.setItem("qr", qrDataURL);
      qrCodeImage.src = qrDataURL;
      qrCodeImage.style.display = "block";
      if (eventCount >= EVENT_THRESHOLD) {
        socket.emit("destroy", sessionName);
        console.log("destroy " + sessionName);
        qrCodeImage.style.filter = 'blur(3px)';
        localStorage.removeItem("qr");
      }
    });
    if (localStorage.getItem("qr")) {
      qrCodeImage.src = localStorage.getItem("qr");
      qrCodeImage.style.display = "block";
    }

    socket.on("ready", () => {
      localStorage.removeItem("qr");
      qrCodeImage.style.display = "none";
      sendMessageButton.disabled = false;
      sendMessageButton.innerHTML = "Send Message";
    });

    socket.on("connecting", () => {
      sendMessageButton.innerHTML = "Wait for Whatsapp client to be ready";
      sendMessageButton.disabled = true;
    });

    socket.on("disconnected", () => {
      location.reload();
    });

    if (sessionName) {
      const response = fetch(`/api/generate-qr/${sessionName}`);
    }

    // send message
    sendMessageButton.addEventListener("click", async (e) => {
      e.preventDefault();
      const form = document.getElementById("sendForm");
      const formdata = new FormData(form);

      const response = await fetch(`/api/send-whatsapp/${sessionName}`, {
        method: "POST",
        body: formdata
      });

      if (response.ok) {
        alert("Message sent successfully");
      } else {
        alert("Error sending message");
      }
    });
  </script>
</body>

</html>